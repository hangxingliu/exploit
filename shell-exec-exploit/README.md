# Shell Exec Exploit Tools

[Document for CTF](CTF.md)

**WARNING! This exploit is used in legal safe test and study, for illegal purposes is strictly prohibited.**

**警告! 此程序仅用于合法的安全测试/渗透与学习, 严禁用于非法目的.**

This exploit is not apply to any situation, modify it in follow locations if you want to use it.   
这个利用程序并不适用于任何测试情况, 请根据实际情况修改下列内容:

- `exploit/libs/config.js` (create it based on `config.example.js`)
- `exploit/libs/bash.js`
- `exploit/libs/core.js` 
	- `#inputFormatter`: function encoding your input 
	- `#responseFormatter`: function decoding output
	- `string: "/etc/php/etc/init.d/apache2"`
	- `string: "/etc/php/etc/apache2/apache2.conf"`

## Snapshot 预览

![](snapshot.jpg)

## Exploit environment 服务器环境

- PHP
- A PHP file support an input to shell execute has not filter these commands:
	- `sed`
	- `bash`
	- `xxd`
	- `stat`
- `/etc/php/etc/init.d/apache2` (It will be replaced to more common file)
- `/etc/php/etc/apache2/apache2.conf` (It will be replaced to more common file)

## Principle 原理

1. Generate simply single line bash script by `sed` from other file on server.
	- `sed $LINE_NUMBER/w$FILE $ORIGINAL_FILE`: extract a line from file
	- `sed s/$FROM/$TO/w$NEW_FILE $FILE`: replace content to new file
2. Generate workspace folder `/tmp/p` by using way *1*.(because `mkdir` be filtered)
3. Create tools `ex` and `ab2c` by using way *1*.
	- `ex <file>`: `chmod 777 $1` make a file executable.
	- `ab2c <file1> <file2> <file3>`: `cat $1 $2 | sed w$3` concatenate two files.
4. Generate single character files from ascii 10 to 13 and 32 to 127 named by its oct number in `/tmp/p/ch`.
	- for example: `printf>/tmp/p/ch/012 \\012` //`\n`
5. Generate more powerful scripts by concatenating single character files above.
	- upgrade `ab2c` to `cat $1 $2 > $3`
	- `sb64 <saveToFile> <base64.1> <base64.2> ...`
		- safe base64(`_a`=>`k`/`_b`=>`K`/`_c`=>`+`/`_d`=>`=`) decoder and writer
		- it is used for received any commands be encoded in safe base64 from client and decode it to file 
6. Simulate server shell based on `sb64` toolkit.
7. Finish! Just execute `./cli.js shell` now.

中文:

1. `sed` 能 通过提取替换系统中别的文件 生成简单的单行命令脚本。 
2. 通过第一条原理, 创建工作环境`/tmp/p` (`mkdir` 被过滤了, 只能这样绕过)
3. 通过第一条原理, 创建简单工具`ex` 和 `ab2c`.
	- `ex`: 将一个文件带上可执行权限
	- `ab2c`: 拼接两个文件到一个新的文件
4. 通过第一条原理, 创建一堆单字节文件到目录`/tmp/p/ch` (ASCII: 10~13, 32~127)
	- 例如写入回车字符文件: `printf>/tmp/p/ch/012 \\012`
5. 通过上述的单字节文本拼接成更强大的工具
	- 将`ab2c`改写成`cat $1 $2 > $3` (相比`sed w$3`减少了输出)
	- `sb64 <saveToFile> <base64.1> <base64.2> ...`
		- 传输安全的base64(`_a`=>`k`/`_b`=>`K`/`_c`=>`+`/`_d`=>`=`) 解码及写入工具
		- 这样就能接受任意从客户端传来的(经过传输安全的base64编码)的命令, 并解码存入文件
6. 通过`sb64`就能构建Shell模拟器了
7. 在`./cli.js`中展开你的脑洞吧.


## Usage 使用

1. Install `node` environment (at least 6.0)
	- <https://nodejs.org/en/download/>
2. `cd exploit; npm install`
3. `cp config.example.js config.js`
4. config `config.js` (for example: change exploit uri)
5. init basic environment on server bt executing `./cli.js init`
6. if last command success then execute `./cli.js shell` to open shell simulator to server.
7. you can upload file to server by executing `./cli.js upload pathOnServer file1 file2 ...` 
	- or `cli.js upload pathOnServer folder/*.bin`
8. destroy environment on server: `./cli.js destroy`
9. in `./cli.js shell`:
	- support `cd`, `pushd`, `popd`, `exit` and most commands
	- `.view remoteFilePath`: view a remote file in encoding safe way
	- `.download remoteFilePath`: download a remote file
	- `.exec remoteFilePath`: same as `remoteFilePath` in normal shell (execute a executable file).
		- why: because command starts with `.` is keyword in Node REPL

中文:

1. 安装`node`环境(至少6.0)
	- <https://nodejs.org/en/download/>
2. `cd exploit; npm install`
3. `cp config.example.js config.js`
4. 配置 `config.js` (例如: 修改测试URI)
5. 执行 `./cli.js init` 以初始化必要环境在服务器上
6. 如果初始化成功, 然后执行 `./cli.js shell` 以打开服务器Shell模拟器.
7. 或执行 `./cli.js upload pathOnServer file1 file2 ...` 来上传文件 
	- 或 `cli.js upload pathOnServer folder/*.bin` 批量上传
8. 销毁服务器上的相关环境: `./cli.js destroy`
9. 在 `./cli.js shell` 打开的Shell模拟器中:
	- 支持 `cd`, `pushd`, `popd`, `exit` 和大部分命令
	- `.view remoteFilePath`: 编码安全地查看一个服务器上的文件
	- `.download remoteFilePath`: 下载一个服务器上的文件
	- `.exec remoteFilePath`: 和正常Shell中的 `remoteFilePath` 命令一样 (执行一个可执行文件).
		- 为什么要这么做: 因为 `.` 打头的命令是关键字在 Node 的 REPL 中


